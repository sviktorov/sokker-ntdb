<!-- templates/best-players.html -->
{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load bootstrap5 %}
{% block title %}{{ page_title }}{% endblock %}
{% load ntdb %}
{% block content %}

<div id="init-data" 
     data-season="{{ season.season }}" 
     data-week="{{ season_week }}">
     {% if extra_skills_form_data %}
        {% for key, value in extra_skills_form_data.items %}
            <input type="hidden" name="start_skill_sublevel_{{ key }}" value="{{ value }}">
        {% endfor %}
    {% endif %}
</div>

<script>
    function calculateSkillLevelFactor(skillLevel) {
        // Base sessions needed for each level range
        skillLevel = parseInt(skillLevel);
        console.log('Calculating skill level factor for:', skillLevel);
        const levelProgression = {
            0: 1,  // 0-1: 1 session
            1: 1,  // 1-2: 1 session
            2: 1,  // 2-3: 1 session
            3: 1,  // 3-4: 1 session
            4: 1,  // 4-5: 2 sessions
            5: 2,  // 5-6: 2 sessions
            6: 2,  // 6-7: 2 sessions
            7: 2,  // 7-8: 2 sessions
            8: 2,  // 8-9: 2 sessions
            9: 3,  // 9-10: 2 sessions
            10: 3, // 10-11: 2 sessions
            11: 3, // 11-12: 4 sessions
            12: 3, // 12-13: 4 sessions
            13: 4, // 13-14: 5 sessions
            14: 4, // 14-15: 5 sessions
            15: 4, // 15-16: 6 sessions
            16: 5, // 16-17: 6 sessions
            17: 5, // 17-18: 7 sessions
            18: 6, // 18-19: 7 sessions
            
        };

        // Get base sessions needed for this level
        const sessionsNeeded = levelProgression[skillLevel] || 6;  // Default to 6 for higher levels
        
        // Return factor that will require this many sessions
        const factor = 1 / sessionsNeeded;
        console.log('Factor for skill level', skillLevel, 'is:', factor);
        return factor;
    }

    function calculatePlayTimeFactor(play_time) {
        play_time_factor = play_time / 100;
        return play_time_factor;
    }

    function calculateTalentFactor(talent) {
        talent_factor = 1;
        talent_factor = BEST_TALENT_FACTOR / talent;
        return talent_factor;
    }
    

    function calculateTrainerFactor(trainer_skill) {
        trainer_factor = 1;
        trainer_factor = trainer_skill / 17;
        return trainer_factor;
    }

    function calculateAgeFactor(age) {
        console.log('Calculating age factor for age:', age);
        if (age <= 16) {
            return 1;
        }
        let age_factor = 1;
        for (let i = 16; i < age; i++) {
            age_factor *= AGE_DECREASE_PER_SESSION;
        }
        return 1/age_factor;
    }
    // Move these outside ALL event handlers and functions to make them truly global
    function updateStaminaButtons(staminaField) {
        if (staminaField) {
            const fieldContainer = staminaField.closest('.mb-3');
            const plusBtn = fieldContainer.querySelector('.plus-skill');
            const minusBtn = fieldContainer.querySelector('.minus-skill');
            
            if (plusBtn) {
                plusBtn.disabled = true;
                plusBtn.title = 'Stamina training not supported';
            }
            if (minusBtn) {
                minusBtn.disabled = true;
                minusBtn.title = 'Stamina training not supported';
            }
            
            const label = fieldContainer.querySelector('label');
            if (label) {
                label.innerHTML += ' <span class="text-muted">(not supported)</span>';
            }
        }
    }

    function initializeExtraSessions(extraSessionsElement) {
        if (extraSessionsElement) {
            const extraSessions = parseInt(extraSessionsElement.value) || 0;
            console.log('Initializing with extra sessions:', extraSessions);
            
            // Get current age for history
            const currentAge = parseFloat(document.querySelector('[name="age"]').value);
            
            // Simulate training for each extra session
            for (let i = 0; i < extraSessions; i++) {
                // Find the skill that was trained
                const skillField = document.querySelector('input[name="extra_trained_skill"]');
                if (skillField) {
                    const trainedSkill = document.querySelector(`input[name="${skillField.value}"]`);
                    if (trainedSkill) {
                        console.log(`Applying extra session ${i + 1} to ${skillField.value}`);
                        
                        // Get current progress and ensure it doesn't exceed 0.99
                        const currentProgress = skillProgress.get(trainedSkill.name) || 0;
                        const newProgress = Math.min(0.99, currentProgress + GENERAL_TRAINING_PERCENTAGE);
                        skillProgress.set(trainedSkill.name, newProgress);
                        
                        // Update display
                        const fieldContainer = trainedSkill.closest('.mb-3');
                        const sublevelDisplay = fieldContainer.querySelector('.sublevel-display');
                        const currentSublevelSpan = fieldContainer.querySelector('.current-sublevel');
                        
                        if (sublevelDisplay) {
                            sublevelDisplay.textContent = `(+${newProgress.toFixed(2)})`;
                        }
                        if (currentSublevelSpan) {
                            currentSublevelSpan.textContent = newProgress.toFixed(2);
                        }
                        
                        // Add to history
                        trainingHistory.push({
                            age: currentAge,
                            skill: trainedSkill.name,
                            action: 'increase',
                            value: trainedSkill.value,
                            remainingSessions: parseInt(document.querySelector('[name="training_sessions"]').value)
                        });
                    }
                }
            }
            
            // Update history display
            displayTrainingHistory();
            
            // Update all button states
            updateAllButtonStates();
            
            console.log('Initialization complete. Training history:', trainingHistory);
        }
    }

    let trainingLog = null;
    let trainingHistory = []; // Global array to track ALL training actions
    const INITIAL_SESSIONS = parseInt('{{ training_sessions_to_spare }}');
    console.log('Initial sessions:', INITIAL_SESSIONS);

    // Add at the top with other globals
    let INITIAL_AGE;
    let START_SEASON;
    let INITIAL_WEEKS_LEFT;

    const SESSIONS_PER_SEASON = 13;

    // Define constants first
    const BEST_TALENT_FACTOR = 3;
    const DEFAULT_TRAINING_SESSIONS = 1;
    const AGE_DECREASE_PER_SESSION = 1.1;
    const START_AGE = 16;
    const SKILL_FACTORS = {
        'pace': 0.662,
        'technique': 0.882,
        'passing': 1.0,
        'keeper': 1.0,
        'defender': 0.809,
        'playmaker': 1.0,
        'striker': 0.809
    };
    
    // Update constant name for clarity
    const GENERAL_TRAINING_PERCENTAGE = 0.15; // 15% general training effect    

    function initializeStartingSublevels(skillProgress) {
        const startSublevels = {};
        
        // Add null checks for all form inputs
        const ageInput = document.querySelector('[name="age"]');
        const talentInput = document.querySelector('[name="talent"]');
        const trainerSkillInput = document.querySelector('[name="trainer_skill"]');
        const playTimeInput = document.querySelector('[name="play_time"]');
        
        // Default values if inputs don't exist yet
        const currentAge = ageInput ? parseFloat(ageInput.value) : START_AGE;
        const talent = talentInput ? parseFloat(talentInput.value) : 3;
        const trainerSkill = trainerSkillInput ? parseFloat(trainerSkillInput.value) : 17;
        const playTime = playTimeInput ? parseFloat(playTimeInput.value) : 100;
        
        document.querySelectorAll('input[name^="start_skill_sublevel_"]').forEach(input => {
            const skillName = input.name.replace('start_skill_sublevel_', '');
            const baseSublevel = input.value || '0';
            console.log(`Processing ${skillName} with base sublevel:`, baseSublevel);
            
            // Get the current skill level with null check
            const skillField = document.querySelector(`input[name="skill${skillName}"]`);
            const skillLevel = skillField ? parseInt(skillField.value) : 1;
            
            // Calculate all factors
            const ageFactor = calculateAgeFactor(currentAge);
            const talentFactor = calculateTalentFactor(talent);
            const trainerFactor = calculateTrainerFactor(trainerSkill);
            const playTimeFactor = calculatePlayTimeFactor(playTime);
            const skillLevelFactor = calculateSkillLevelFactor(skillLevel);
            
            // Apply all factors to the base sublevel
            const adjustedSublevel = parseFloat(baseSublevel) * 
                ageFactor * 
                talentFactor * 
                trainerFactor * 
                playTimeFactor * 
                skillLevelFactor;
            
            // Ensure sublevel doesn't exceed 0.99
            const cappedSublevel = Math.min(0.99, adjustedSublevel);
            
            console.log(`Factors for ${skillName}:`, {
                age: ageFactor,
                talent: talentFactor,
                trainer: trainerFactor,
                playTime: playTimeFactor,
                skillLevel: skillLevelFactor,
                base: baseSublevel,
                adjusted: adjustedSublevel,
                capped: cappedSublevel
            });
            
            // Initialize the sublevel directly from the input value
            startSublevels[skillName] = cappedSublevel;
            
            // Initialize the skill progress with the starting sublevel
            skillProgress.set(skillName, cappedSublevel);
            
            // Update the display with null checks
            const fieldContainer = input.closest('.mb-3');
            if (fieldContainer) {
                const sublevelDisplay = fieldContainer.querySelector('.sublevel-display');
                const currentSublevelSpan = fieldContainer.querySelector('.current-sublevel');
                
                if (sublevelDisplay) {
                    sublevelDisplay.textContent = `(+${cappedSublevel.toFixed(2)})`;
                }
                if (currentSublevelSpan) {
                    currentSublevelSpan.textContent = cappedSublevel.toFixed(2);
                }
            }
        });
        return startSublevels;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Disable stamina buttons first
        const staminaField = document.querySelector('input[name="skillstamina"]');
        updateStaminaButtons(staminaField);

        // Initialize sublevels from extra sessions
        const extraSessionsElement = document.getElementById('extra_sessions');
        initializeExtraSessions(extraSessionsElement);

        // Initialize trainingLog immediately
        trainingLog = document.getElementById('training-log');

        var form = document.getElementById('player-update-form');
        var submitButton = form.querySelector('button[type="submit"]');
        var trainingSessionsField = form.querySelector('[name="training_sessions"]');
        var playerForm = document.getElementById('player-update-form-2');
                
        // Get data from hidden element
        const initData = document.getElementById('init-data');
        const initialSeason = parseInt(initData.dataset.season);
        const initialWeek = parseInt(initData.dataset.week);
        let currentSeason = initialSeason;
        let currentWeek = initialWeek;
        const ageField = document.querySelector('input[name="age"]');
        const ageFeedback = document.getElementById('age-feedback');
        const seasonFeedback = document.getElementById('season-feedback');
        const weekFeedback = document.getElementById('week-feedback');
        const remainingSessionsSpan = document.getElementById('remaining-sessions');
        
        // Get current player age
        const currentAgeField = document.querySelector('input[name="current_age"]');
        const currentAge = currentAgeField ? parseInt(currentAgeField.value) : START_AGE;

        // Set initial values for feedback spans
        if (ageField) {
            ageFeedback.textContent = ageField.value || currentAge;
        }
        seasonFeedback.textContent = currentSeason;
        weekFeedback.textContent = currentWeek;
        remainingSessionsSpan.textContent = trainingSessionsField.value || '0';
        
        // Add a Map to store fractional progress for each skill
        const skillProgress = new Map();
        
        // Replace the inline initialization with the function call
        const startSublevels = initializeStartingSublevels(skillProgress);

        // Make sure extra trainings are included in the init-data div
        console.log('Init data content:', initData.innerHTML);

        // Store initial age
        if (ageField) {
            INITIAL_AGE = parseFloat(ageField.value);
            console.log('Stored initial age:', INITIAL_AGE);
        }

        // Get initial age and weeks left
        const weeksLeftSpan = document.getElementById('weeks-left');
        const seasonStart = document.getElementById('season-start');
        
        if (ageField && weeksLeftSpan) {
            START_SEASON = parseInt(seasonStart.textContent);  // Get season from span instead of age
            INITIAL_WEEKS_LEFT = parseInt(weeksLeftSpan.textContent);
            
            // Update season display
            if (seasonFeedback) {
                seasonFeedback.textContent = START_SEASON;
            }
            
            console.log('Initial values:', {
                age: INITIAL_AGE,
                startSeason: START_SEASON,
                weeksLeft: INITIAL_WEEKS_LEFT
            });
        }

        // Core functions for skill training
        function handleSkillIncrease(skill, isReplay = false) {
            let cleanSkillName = skill.name.toLowerCase();
            const skillNameMap = {
                'skilldefending': 'defender',
                'skillplaymaking': 'playmaker',
                'skillgoalkeeping': 'keeper',
                'skillkeeping': 'keeper',
                'skillkeeper': 'keeper',
                'keeper': 'keeper',
                'skilltechnique': 'technique',
                'skillscoring': 'striker'  // Changed to striker to match SKILL_FACTORS
            };
            
            cleanSkillName = skillNameMap[cleanSkillName] || cleanSkillName.replace('skill', '');
            const factor = SKILL_FACTORS[cleanSkillName];
            
            if (!factor) {
                console.error('No factor found for skill:', cleanSkillName);
                return;
            }
            const currentAge = parseFloat(document.querySelector('[name="age"]').value);
            const talent = parseFloat(document.querySelector('[name="talent"]').value);
            const trainer_skill = parseFloat(document.querySelector('[name="trainer_skill"]').value);
            const play_time = parseFloat(document.querySelector('[name="play_time"]').value);
            const ageFactor = calculateAgeFactor(currentAge);
            const talentFactor = calculateTalentFactor(talent);
            const trainerFactor = calculateTrainerFactor(trainer_skill);
            const playTimeFactor = calculatePlayTimeFactor(play_time);
            const skillLevelFactor = calculateSkillLevelFactor(parseInt(skill.value));
            console.log('Age factor:', ageFactor);
            
            // One training session gives 'factor' points, adjusted by age factor
            const sublevelProgress = (factor / DEFAULT_TRAINING_SESSIONS) * ageFactor * talentFactor * trainerFactor * playTimeFactor * skillLevelFactor    ;
            
            // Apply the same age factor to general training effect
            const generalTrainingEffect = GENERAL_TRAINING_PERCENTAGE * ageFactor * talentFactor * trainerFactor * playTimeFactor * skillLevelFactor;
            
            const currentProgress = skillProgress.get(skill.name) || 0;
            let newProgress = currentProgress + sublevelProgress;
            
            if (newProgress >= 1) {
                newProgress = newProgress - 1;
                skill.value = parseInt(skill.value) + 1;
            }
            
            skillProgress.set(skill.name, newProgress);
            
            const fieldContainer = skill.closest('.mb-3');
            const sublevelDisplay = fieldContainer.querySelector('.sublevel-display');
            const currentSublevelSpan = fieldContainer.querySelector('.current-sublevel');
            
            if (sublevelDisplay) {
                sublevelDisplay.textContent = `(+${newProgress.toFixed(2)})`;
            }
            if (currentSublevelSpan) {
                currentSublevelSpan.textContent = newProgress.toFixed(2);
            }
            
            // Apply general training effect to other skills, also adjusted by age factor
            document.querySelectorAll('#player-update-form-2 input[type="number"]').forEach(otherSkill => {
                if (otherSkill !== skill) {
                    const otherSkillName = otherSkill.name;
                    const otherProgress = skillProgress.get(otherSkillName) || 0;
                    let newOtherProgress = otherProgress + generalTrainingEffect;
                    
                    if (newOtherProgress >= 1) {
                        newOtherProgress = newOtherProgress - 1;
                        otherSkill.value = parseInt(otherSkill.value) + 1;
                    }
                    
                    skillProgress.set(otherSkillName, newOtherProgress);
                    
                    const otherContainer = otherSkill.closest('.mb-3');
                    const otherSublevelDisplay = otherContainer.querySelector('.sublevel-display');
                    const otherCurrentSublevelSpan = otherContainer.querySelector('.current-sublevel');
                    
                    if (otherSublevelDisplay) {
                        otherSublevelDisplay.textContent = `(+${newOtherProgress.toFixed(2)})`;
                    }
                    if (otherCurrentSublevelSpan) {
                        otherCurrentSublevelSpan.textContent = newOtherProgress.toFixed(2);
                    }
                }
            });
            
            // Decrease available training sessions and update age if needed
            const trainingSessionsField = document.querySelector('[name="training_sessions"]');
            const currentSessions = parseInt(trainingSessionsField.value);
            const newSessions = currentSessions - 1;
            
            // Calculate weeks left
            const sessionsUsed = INITIAL_SESSIONS - newSessions;
            let weeksLeft = Math.max(0, INITIAL_WEEKS_LEFT - sessionsUsed);
            
            // Calculate seasons passed
            let seasonsPassed = 0;
            if (sessionsUsed > INITIAL_WEEKS_LEFT) {
                const remainingSessions = sessionsUsed - INITIAL_WEEKS_LEFT;
                seasonsPassed = Math.floor(remainingSessions / SESSIONS_PER_SEASON) + 1;
                weeksLeft = SESSIONS_PER_SEASON - (remainingSessions % SESSIONS_PER_SEASON);
            }
            
            // Update age and season (ensure they only increase)
            const newAge = INITIAL_AGE + seasonsPassed;
            const newSeason = START_SEASON + seasonsPassed;  // Remove modulo operation
            
            console.log('Season calculation:', {
                START_SEASON,
                seasonsPassed,
                newSeason,
                sessionsUsed,
                weeksLeft
            });
            
            // Update displays
            const ageField = document.querySelector('[name="age"]');
            ageField.value = newAge.toFixed(2);
            
            const ageFeedback = document.getElementById('age-feedback');
            if (ageFeedback) {
                ageFeedback.textContent = newAge.toFixed(2);
            }
            
            // Update both season spans
            const seasonStart = document.getElementById('season-start');
            const seasonFeedback = document.getElementById('season-feedback');
            if (seasonStart) {
                seasonStart.textContent = newSeason;
            }
            if (seasonFeedback) {
                seasonFeedback.textContent = newSeason;
            }
            
            const weeksLeftSpan = document.getElementById('weeks-left');
            if (weeksLeftSpan) {
                weeksLeftSpan.textContent = weeksLeft;
            }
            
            console.log('Updates:', {
                sessionsUsed,
                weeksLeft,
                seasonsPassed,
                newAge,
                newSeason,
                remainingSessions: sessionsUsed - INITIAL_WEEKS_LEFT
            });
            
            // Update sessions
            trainingSessionsField.value = newSessions;
            const remainingSessionsSpan = document.getElementById('remaining-sessions');
            if (remainingSessionsSpan) {
                remainingSessionsSpan.textContent = newSessions;
            }
            
            // Update button states
            const plusBtn = fieldContainer.querySelector('.plus-skill');
            const minusBtn = fieldContainer.querySelector('.minus-skill');
            const remainingSessions = parseInt(trainingSessionsField.value);
            
            if (plusBtn) {
                plusBtn.disabled = remainingSessions <= 0;
            }
            if (minusBtn) {
                // Enable minus button as soon as we have an increase
                minusBtn.disabled = false;
            }
            
            // Only add to history if this is not a replay
            if (!isReplay) {
                const remainingSessions = parseInt(trainingSessionsField.value);
                updateTrainingHistory({
                    skill: skill.name,
                    type: 'increase',
                    value: skill.value,
                    remainingSessions: remainingSessions
                });
            }
        }

        function handleSkillDecrease(skill) {
            console.log('Decreasing skill:', skill.name);
            console.log('Current INITIAL_SESSIONS:', INITIAL_SESSIONS);
            
            // Find the last increase for this skill and remove it
            const lastIncreaseIndex = [...trainingHistory].reverse().findIndex(entry => {
                const currentSkill = entry.skill.toLowerCase();
                const targetSkill = skill.name.toLowerCase();
                const isMatch = currentSkill === targetSkill;
                return isMatch && entry.action === 'increase';
            });
            
            if (lastIncreaseIndex === -1) {
                console.log('No increase found to undo for:', skill.name);
                return;
            }
            
            // Remove the last increase from history
            const actualIndex = trainingHistory.length - 1 - lastIncreaseIndex;
            const removedEntry = trainingHistory.splice(actualIndex, 1)[0];
            console.log('Removed history entry:', removedEntry);
            
            // Reset all skills to initial values
            document.querySelectorAll('#player-update-form-2 input[type="number"]').forEach(field => {
                const initialValue = field.dataset.initialValue || field.value;
                field.value = initialValue;
                skillProgress.set(field.name, 0);
                
                // Reset displays
                const fieldContainer = field.closest('.mb-3');
                const sublevelDisplay = fieldContainer.querySelector('.sublevel-display');
                const currentSublevelSpan = fieldContainer.querySelector('.current-sublevel');
                
                if (sublevelDisplay) {
                    sublevelDisplay.textContent = '(+0.00)';
                }
                if (currentSublevelSpan) {
                    currentSublevelSpan.textContent = '0.00';
                }
            });
            
            // Reset sessions to initial value
            const trainingSessionsField = document.querySelector('[name="training_sessions"]');
            trainingSessionsField.value = INITIAL_SESSIONS;
            const remainingSessionsSpan = document.getElementById('remaining-sessions');
            if (remainingSessionsSpan) {
                remainingSessionsSpan.textContent = INITIAL_SESSIONS;
            }
            
            console.log('Reset to initial sessions:', INITIAL_SESSIONS);
            
            // Apply initial sublevels
            const extraSessionsElement = document.getElementById('extra_sessions');
            const extraTrainedSkillElement = document.getElementById('extra_trained_skill');
            
            if (extraSessionsElement && extraTrainedSkillElement) {
                // ... existing initial sublevels code ...
            }
            
            // Then replay all remaining history actions
            console.log('Starting replay with sessions:', INITIAL_SESSIONS);
            replayTrainingHistory(INITIAL_SESSIONS);
            
            // Update displays
            displayTrainingHistory();
            
            // Update button states for all skills
            updateAllButtonStates();
        }

        function replayTrainingHistory(startingSessions) {
            console.log('Starting replay with sessions:', startingSessions);
            let remainingSessions = startingSessions;
            
            // Reset age, season and weeks to initial values
            const ageField = document.querySelector('[name="age"]');
            ageField.value = INITIAL_AGE;
            
            const ageFeedback = document.getElementById('age-feedback');
            if (ageFeedback) {
                ageFeedback.textContent = INITIAL_AGE.toFixed(2);
            }
            
            // Reset both season spans
            const seasonStart = document.getElementById('season-start');
            const seasonFeedback = document.getElementById('season-feedback');
            if (seasonStart) {
                seasonStart.textContent = START_SEASON;
            }
            if (seasonFeedback) {
                seasonFeedback.textContent = START_SEASON;
            }
            
            const weeksLeftSpan = document.getElementById('weeks-left');
            if (weeksLeftSpan) {
                weeksLeftSpan.textContent = INITIAL_WEEKS_LEFT;
            }
            
            trainingHistory.forEach((entry, index) => {
                const skill = document.querySelector(`input[name="${entry.skill}"]`);
                if (skill && entry.action === 'increase') {
                    // Update sessions before each increase
                    const trainingSessionsField = document.querySelector('[name="training_sessions"]');
                    trainingSessionsField.value = remainingSessions;
                    const remainingSessionsSpan = document.getElementById('remaining-sessions');
                    if (remainingSessionsSpan) {
                        remainingSessionsSpan.textContent = remainingSessions;
                    }
                    
                    handleSkillIncrease(skill, true);
                    remainingSessions--;
                    
                    console.log(`After replay ${index}:`, {
                        skill: entry.skill,
                        sessionsRemaining: remainingSessions,
                        currentAge: ageField.value
                    });
                }
            });
        }

        function updateTrainingHistory(action) {
            const currentAge = parseFloat(document.querySelector('[name="age"]').value);
            const remainingSessions = parseInt(document.querySelector('[name="training_sessions"]').value);
            
            console.log('Adding to history:', {
                age: currentAge,
                skill: action.skill,
                action: action.type,
                value: action.value,
                remainingSessions: remainingSessions
            });
            
            trainingHistory.push({
                age: currentAge,
                skill: action.skill,
                action: action.type,
                value: action.value,
                remainingSessions: remainingSessions
            });
            
            displayTrainingHistory();
        }

        function displayTrainingHistory() {
            const historyList = document.getElementById('training-log');
            if (!historyList) return;
            
            // Reverse the array to display latest entries first
            historyList.innerHTML = [...trainingHistory].reverse().map((entry, index) => {
                const ageFactor = calculateAgeFactor(entry.age);
                const talent = parseFloat(document.querySelector('[name="talent"]').value);
                const talentFactor = calculateTalentFactor(talent);
                const trainerSkill = parseFloat(document.querySelector('[name="trainer_skill"]').value);
                const trainerFactor = calculateTrainerFactor(trainerSkill);
                const playTime = parseFloat(document.querySelector('[name="play_time"]').value);
                const playTimeFactor = calculatePlayTimeFactor(playTime);
                const skillLevel = parseInt(entry.value);
                const skillLevelFactor = calculateSkillLevelFactor(skillLevel);
                
                return `
                    <div class="history-entry ${entry.action}" style="margin-bottom: 5px;">
                        <span class="badge ${entry.action === 'increase' ? 'bg-success' : 'bg-danger'} me-2">
                            ${entry.action === 'increase' ? '+' : '-'}
                        </span>
                        <strong>${entry.skill.replace('skill', '').toLowerCase()}</strong> 
                        at age ${entry.age.toFixed(2)}
                        <span class="text-muted">(Level: ${entry.value})</span>
                        <span class="text-info ms-2">Sessions: ${entry.remainingSessions}</span>
                        <span class="text-warning ms-2">Age Factor: ${ageFactor.toFixed(3)}x</span>
                        <span class="text-primary ms-2">Talent Factor: ${talentFactor.toFixed(3)}x</span>
                        <span class="text-success ms-2">Trainer Factor: ${trainerFactor}x</span>
                        <span class="text-danger ms-2">Play Time Factor: ${playTimeFactor.toFixed(3)}x</span>
                        <span class="text-secondary ms-2">Skill Level Factor: ${skillLevelFactor.toFixed(3)}x</span>
                    </div>
                `;
            }).join('');
            
            console.log('Current training history:', [...trainingHistory].reverse().map(entry => ({
                skill: entry.skill,
                action: entry.action,
                sessions: entry.remainingSessions,
                age: entry.age,
                ageFactor: calculateAgeFactor(entry.age),
                talentFactor: calculateTalentFactor(parseFloat(document.querySelector('[name="talent"]').value)),
                trainerFactor: calculateTrainerFactor(parseFloat(document.querySelector('[name="trainer_skill"]').value)),
                playTimeFactor: calculatePlayTimeFactor(parseFloat(document.querySelector('[name="play_time"]').value)),
                skillLevelFactor: calculateSkillLevelFactor(parseInt(entry.value))
            })));
        }

        function handleSkillChange(skill, increment, isReplay = false) {
            if (increment) {
                handleSkillIncrease(skill, isReplay);
            } else {
                handleSkillDecrease(skill);
            }
        }

        // Show/hide skill buttons based on training sessions
        function updateSkillButtons() {
            const sessions = parseInt(trainingSessionsField.value) || 0;
            const skillFields = playerForm.querySelectorAll('input[type="number"]');
            
            skillFields.forEach(field => {
                const fieldContainer = field.closest('.mb-3');
                const buttonsContainer = fieldContainer.querySelector('.skill-buttons');
                
                if (sessions > 0) {
                    if (!buttonsContainer) {
                        field.dataset.initialValue = field.value;
                        
                        // Remove the original label if it exists
                        const originalLabel = fieldContainer.querySelector('label');
                        if (originalLabel) {
                            originalLabel.remove();
                        }
                        
                        const buttons = `
                            <label>${field.name.replace('skill', '').toLowerCase()}</label>
                            <span class="sublevel-display ms-1">(+${skillProgress.get(field.name)?.toFixed(2) || '0.00'})</span>
                            <div class="skill-buttons">
                                <button type="button" class="btn btn-sm btn-secondary minus-skill">-</button>
                                <button type="button" class="btn btn-sm btn-secondary plus-skill">+</button>
                            </div>
                            <div class="feedback-row">
                                <div class="alert alert-info py-1 px-2 d-inline-block mb-0" style="font-size: 0.875rem;">
                                    Current sublevel: <strong><span class="current-sublevel">${skillProgress.get(field.name) || '0.00'}</span></strong>
                                </div>
                                <span class="sessions-feedback"></span>
                            </div>`;
                        fieldContainer.insertAdjacentHTML('afterbegin', buttons);
                        
                        // Insert the field after the label
                        const label = fieldContainer.querySelector('label');
                        label.insertAdjacentElement('afterend', field);
                        
                        // Add click handlers
                        const plusBtn = fieldContainer.querySelector('.plus-skill');
                        const minusBtn = fieldContainer.querySelector('.minus-skill');
                        
                        plusBtn.addEventListener('click', () => handleSkillChange(field, true, false));
                        minusBtn.addEventListener('click', () => handleSkillChange(field, false, false));
                    }
                    
                    // Update button states
                    const plusBtn = fieldContainer.querySelector('.plus-skill');
                    const minusBtn = fieldContainer.querySelector('.minus-skill');
                    const currentValue = parseInt(field.value);
                    const initialValue = parseInt(field.dataset.initialValue);
                    
                    if (plusBtn) {
                        plusBtn.disabled = sessions <= 0;
                    }
                    if (minusBtn) {
                        minusBtn.disabled = currentValue <= initialValue;
                    }
                } else if (buttonsContainer) {
                    buttonsContainer.remove();
                    // Re-add the original label and ensure proper order
                    fieldContainer.innerHTML = ''; // Clear container
                    fieldContainer.insertAdjacentHTML('afterbegin', `<label>${field.name.replace('skill', '').toLowerCase()}</label>`);
                    fieldContainer.appendChild(field);
                }
            });
        }

        trainingSessionsField.addEventListener('input', function() {
            remainingSessionsSpan.textContent = this.value || '0';
            updateSkillButtons();
        });
        submitButton.addEventListener('click', function(event) {
            event.preventDefault();
            form.submit();
        });
        
        // Initial check
        updateSkillButtons();

        // Add CSS animation and styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateY(-10px); }
                20% { opacity: 1; transform: translateY(0); }
                80% { opacity: 1; }
                100% { opacity: 0; }
            }
            .sessions-feedback {
                font-size: 0.875rem;
                font-weight: 500;
                color: #2e7d32;
                background-color: #e8f5e9;
                padding: 4px 8px;
                border-radius: 4px;
                margin-left: 8px;
                white-space: nowrap;
                vertical-align: middle;
                min-height: 48px;
                line-height: 1.2;
                display: inline-flex;
                align-items: center;
                opacity: 0;  /* Start hidden */
            }
            .alert.py-1 {
                display: inline-flex;
                vertical-align: middle;
                white-space: nowrap;
                min-height: 48px;
                align-items: center;
                padding-top: 8px;
                padding-bottom: 8px;
                margin-left: 16px;
            }
            .feedback-row {
                display: inline-flex;
                align-items: center;
                min-height: 48px;
            }
            input[type="number"].form-control {
                width: 45px;
                display: inline-block;
                padding: 4px 8px;
                height: 32px;
                font-size: 0.9rem;
                /* Remove spinner buttons for number inputs */
                -moz-appearance: textfield;
            }
            /* Remove spinner buttons for Chrome, Safari, Edge, Opera */
            input[type="number"].form-control::-webkit-outer-spin-button,
            input[type="number"].form-control::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            /* Center the text in the input */
            input[type="number"].form-control {
                text-align: center;
            }
            .mb-3 {
                min-height: 48px;
                display: flex;
                align-items: center;
                flex-wrap: nowrap;
            }
            .mb-3 label {
                display: inline-block;
                width: 100px;
                margin-bottom: 0;
                font-size: 0.9rem;
                text-transform: capitalize;
            }
            .status-display {
                display: inline-flex;
                margin-left: 10px;
                color: #1976d2;
                font-weight: 500;
                white-space: nowrap;
                align-items: center;
                min-height: 48px;
            }
            .skill-buttons {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                margin-left: 8px;
                min-height: 48px;
            }
            .skill-buttons button {
                padding: 4px 8px;
                min-width: 32px;
            }
            .skill-buttons .alert {
                margin-left: 16px;
                margin-bottom: 0;
            }
            .sessions-feedback {
                margin-left: 8px;
                transition: opacity 0.3s ease;
            }
            .sublevel-display {
                color: #1976d2;
                font-size: 0.9rem;
                font-weight: 500;
                margin: 0 8px;
            }
            #training-history-container {
                margin-top: 20px;
            }
            #training-history-list {
                max-height: 300px;
                overflow-y: auto;
            }
            .history-entry {
                font-size: 0.9rem;
                padding: 4px 8px;
                border-radius: 4px;
                margin-bottom: 8px;
            }
            .history-entry:hover {
                background-color: #f8f9fa;
            }
            .history-entry.increase {
                border-left: 3px solid #198754;
            }
            .history-entry.decrease {
                border-left: 3px solid #dc3545;
            }
            #training-log {
                max-height: 300px;
                overflow-y: auto;
                padding: 10px;
            }
            .history-entry {
                font-size: 0.9rem;
                padding: 4px 8px;
                border-radius: 4px;
                margin-bottom: 8px;
                background-color: white;
            }
            .history-entry:hover {
                background-color: #f8f9fa;
            }
            .history-entry.increase {
                border-left: 3px solid #198754;
            }
            .history-entry.decrease {
                border-left: 3px solid #dc3545;
            }
            /* Panel styling for both containers */
            .player-prediction-container, .player-input-container {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                padding: 20px;
                margin-bottom: 20px;
                border: 1px solid rgba(0,0,0,.125);
                transition: box-shadow .3s ease-in-out;
            }

            /* Specific styling for player-input-container */
            .player-input-container {
                background-color: #f8f9fa;  /* Lighter gray background */
                border-color: #e9ecef;
            }

            /* Separator column styling */
            .separator-column {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .arrow-right {
                font-size: 24px;
                color: #6c757d;
                padding: 10px;
                border-radius: 50%;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Hover effects */
            .player-prediction-container:hover {
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

            .player-input-container:hover {
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                background-color: #f1f3f5;  /* Slightly darker on hover */
            }

            /* Rest of existing styles ... */
        `;
        document.head.appendChild(style);

        // Add status display in a visible location after the hidden field
        const sessionsFeedback = document.createElement('span');
        sessionsFeedback.className = 'sessions-feedback';
        sessionsFeedback.style.display = 'none';  // Hide the element
        
        // Insert after the first form-group/row
        const firstFormGroup = document.querySelector('.form-group, .row');
        firstFormGroup.parentNode.insertBefore(sessionsFeedback, firstFormGroup.nextSibling);

        // Update sessions feedback when value changes
        const updateSessionsFeedback = () => {
            sessionsFeedback.textContent = `${trainingSessionsField.value} sessions left`;
        };

        // Add this near the top after other variable declarations
        const skillFactorsTable = document.getElementById('skill-factors-table');
        if (skillFactorsTable) {
            const tableContent = Object.entries(SKILL_FACTORS)
                .map(([skill, factor]) => {
                    const exactSessions = DEFAULT_TRAINING_SESSIONS / factor;
                    const neededSessions = Math.ceil(exactSessions);
                    const fractionalPart = exactSessions % 1;
                    return `
                        <tr>
                            <td class="text-capitalize">${skill}</td>
                            <td>${factor.toFixed(3)}</td>

                        </tr>
                    `;
                }).join('');
            skillFactorsTable.innerHTML = tableContent;
        }

        // Create and add info section if it doesn't exist
        let infoSection = document.querySelector('.training-info-section');
        console.log('Initial info section:', infoSection);

        if (!infoSection) {
            const container = document.querySelector('.row:nth-child(3)');
            console.log('Container found:', container);
            
            if (container) {
                // First info section (existing)
                infoSection = document.createElement('div');
                infoSection.className = 'row mt-4';
                infoSection.innerHTML = `
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h4>Age Factor Information</h4>
                            <div id="skill-factors-table"></div>
                            <hr class="my-2">
                            <p><strong>Age Effect on Training:</strong></p>
                            <ul>
                                <li>Base training at age ${START_AGE}</li>
                                <li>After age ${START_AGE}, training becomes harder:</li>
                                <ul>
                                    <li>Age ${START_AGE + 1}: +${((AGE_DECREASE_PER_SESSION - 1) * 100).toFixed(1)}% sessions (${AGE_DECREASE_PER_SESSION}x)</li>
                                    <li>Age ${START_AGE + 2}: +${((Math.pow(AGE_DECREASE_PER_SESSION, 2) - 1) * 100).toFixed(1)}% sessions (${Math.pow(AGE_DECREASE_PER_SESSION, 2).toFixed(3)}x)</li>
                                </ul>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h4>Talent Factor Information</h4>
                            <p><strong>How Talent Affects Training:</strong></p>
                            <ul>
                                <li>Talent ranges from 3 to 8</li>
                                <li>Training effectiveness is calculated as: ${BEST_TALENT_FACTOR}/talent</li>
                                <li>Examples:</li>
                                <ul>
                                    <li>Talent 3: Factor = ${(BEST_TALENT_FACTOR/3).toFixed(3)}x (fastest training)</li>
                                    <li>Talent 4: Factor = ${(BEST_TALENT_FACTOR/4).toFixed(3)}x</li>
                                    <li>Talent 5: Factor = ${(BEST_TALENT_FACTOR/5).toFixed(3)}x</li>
                                    <li>Talent 6: Factor = ${(BEST_TALENT_FACTOR/6).toFixed(3)}x</li>
                                    <li>Talent 7: Factor = ${(BEST_TALENT_FACTOR/7).toFixed(3)}x</li>
                                    <li>Talent 8: Factor = ${(BEST_TALENT_FACTOR/8).toFixed(3)}x (slowest training)</li>
                                </ul>
                                <li>Lower talent means faster skill improvement</li>
                                <li>Each training session is multiplied by this factor</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h4>Trainer Factor Information</h4>
                            <p><strong>How Trainer Skill Affects Training:</strong></p>
                            <ul>
                                <li>Trainer's skill in the trained attribute directly affects training effectiveness</li>
                                <li>Skill range: 1 to 17</li>
                                <li>Level 17 provides 100% effectiveness</li>
                                <li>Examples:</li>
                                <ul>
                                    <li>Level 17: 100% effectiveness (maximum)</li>
                                    <li>Level 16: ${((16/17)*100).toFixed(2)}% effectiveness (most common)</li>
                                    <li>Level 15: ${((15/17)*100).toFixed(2)}% effectiveness</li>
                                    <li>Level 10: ${((10/17)*100).toFixed(2)}% effectiveness</li>
                                    <li>Level 5: ${((5/17)*100).toFixed(2)}% effectiveness</li>
                                    <li>Level 1: ${((1/17)*100).toFixed(2)}% effectiveness (minimum)</li>
                                </ul>
                            </ul>
                        </div>
                    </div>
                `;
                container.appendChild(infoSection);
                
                // Additional info section (new)
                const additionalSection = document.createElement('div');
                additionalSection.className = 'row mt-4';
                additionalSection.innerHTML = `
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h4>Skill Level Factor Information</h4>
                            <p><strong>How Current Skill Level Affects Training:</strong></p>
                            <ul>
                                <li>Training becomes harder at higher skill levels</li>
                                <li>Factor calculated as: 1.15^(level-3) normalized to level 1</li>
                                <li>Examples:</li>
                                <ul>
                                    <li>Level 1: ${calculateSkillLevelFactor(1).toFixed(3)}x (fastest training)</li>
                                    <li>Level 5: ${calculateSkillLevelFactor(5).toFixed(3)}x</li>
                                    <li>Level 10: ${calculateSkillLevelFactor(10).toFixed(3)}x</li>
                                    <li>Level 15: ${calculateSkillLevelFactor(15).toFixed(3)}x</li>
                                    <li>Level 17: ${calculateSkillLevelFactor(17).toFixed(3)}x (slowest training)</li>
                                </ul>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h4>Play Time Factor Information</h4>
                            <p><strong>How Play Time Affects Training:</strong></p>
                            <ul>
                                <li>Play time range: 50% to 100%</li>
                                <li>Factor is directly proportional to play time</li>
                                <li>Examples:</li>
                                <ul>
                                    <li>100% play time: ${calculatePlayTimeFactor(100).toFixed(3)}x (maximum)</li>
                                    <li>96% play time: ${calculatePlayTimeFactor(96).toFixed(3)}x</li>
                                    <li>75% play time: ${calculatePlayTimeFactor(75).toFixed(3)}x</li>
                                    <li>50% play time: ${calculatePlayTimeFactor(50).toFixed(3)}x (minimum)</li>
                                </ul>
                                <li>More play time = faster training</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h4>Reserved for Future Use</h4>
                            <p>This space is reserved for additional training information.</p>
                        </div>
                    </div>
                `;
                container.appendChild(additionalSection);
                console.log('Additional info section added:', additionalSection);
            }
        }

        // Add console log for debugging
        console.log('SKILL_FACTORS:', SKILL_FACTORS);
        console.log('skillFactorsTable element:', skillFactorsTable);
        console.log('Table HTML generated:', skillFactorsTable?.innerHTML);

        function updateButtonStates() {
            const trainingSessionsField = document.querySelector('[name="training_sessions"]');
            const remainingSessions = parseInt(trainingSessionsField.value);
            
            document.querySelectorAll('#player-update-form-2 input[type="number"]').forEach(field => {
                const fieldContainer = field.closest('.mb-3');
                const plusBtn = fieldContainer.querySelector('.plus-skill');
                const minusBtn = fieldContainer.querySelector('.minus-skill');
                const currentValue = parseInt(field.value);
                const initialValue = parseInt(field.dataset.initialValue || field.value);
                const hasTrainingHistory = trainingHistory.some(entry => 
                    entry.skill === field.name && entry.action === 'increase'
                );
                
                console.log('Updating buttons for:', field.name, {
                    currentValue,
                    initialValue,
                    remainingSessions,
                    hasTrainingHistory,
                    currentProgress: skillProgress.get(field.name) || 0
                });
                
                if (plusBtn) {
                    plusBtn.disabled = remainingSessions <= 0;
                }
                if (minusBtn) {
                    // Enable minus if there's any training history for this skill
                    minusBtn.disabled = !hasTrainingHistory;
                }
            });
        }

        // Add this line after any skill value changes
        document.querySelectorAll('#player-update-form-2 input[type="number"]').forEach(input => {
            input.addEventListener('change', updateButtonStates);
        });

        // New function to update all button states
        function updateAllButtonStates() {
            const trainingSessionsField = document.querySelector('[name="training_sessions"]');
            const remainingSessions = parseInt(trainingSessionsField.value);
            
            document.querySelectorAll('#player-update-form-2 input[type="number"]').forEach(field => {
                const fieldContainer = field.closest('.mb-3');
                const plusBtn = fieldContainer.querySelector('.plus-skill');
                const minusBtn = fieldContainer.querySelector('.minus-skill');
                const currentValue = parseInt(field.value);
                const initialValue = parseInt(field.dataset.initialValue || field.value);
                const hasTrainingHistory = trainingHistory.some(entry => 
                    entry.skill === field.name && entry.action === 'increase'
                );
                
                console.log('Updating buttons for:', field.name, {
                    currentValue,
                    initialValue,
                    remainingSessions,
                    hasTrainingHistory,
                    currentProgress: skillProgress.get(field.name) || 0
                });
                
                if (plusBtn) {
                    plusBtn.disabled = remainingSessions <= 0;
                }
                if (minusBtn) {
                    // Enable minus if there's any training history for this skill
                    minusBtn.disabled = !hasTrainingHistory;
                }
            });
        }
    });

    // Add this function to calculate the starting sublevel including extra sessions
    function calculateStartingSublevel(skillName, baseSublevel) {
        const extraTrainingsInput = document.querySelector('input[name="extra_trainings"]');
        if (!extraTrainingsInput) {
            console.error('Extra trainings input not found in DOM');
            // Check if the input might be in the init-data div
            const initData = document.getElementById('init-data');
            console.log('Init data available:', !!initData);
            if (initData) {
                console.log('Init data content:', initData.innerHTML);
            }
            return Math.min(0.99, parseFloat(baseSublevel));
        }

        // Debug logs
        console.log('Base sublevel:', baseSublevel);
        console.log('Extra trainings input value:', extraTrainingsInput.value);
        console.log('Skill name:', skillName);
        
        try {
            const extraTrainings = JSON.parse(extraTrainingsInput.value || '{}');
            console.log('Parsed extra trainings:', extraTrainings);
            
            // Convert skillName to match the format in extraTrainings
            const cleanSkillName = skillName.replace('start_skill_sublevel_', '');
            const formattedSkillName = cleanSkillName.startsWith('skill') ? cleanSkillName : 'skill' + cleanSkillName.toLowerCase();
            console.log('Formatted skill name:', formattedSkillName);
            
            const extraSessions = parseInt(extraTrainings[formattedSkillName] || 0);
            console.log('Extra sessions:', extraSessions);
            
            // Use GENERAL_TRAINING_PERCENTAGE instead of hardcoded 0.25
            const totalSublevel = Math.min(0.99, parseFloat(baseSublevel) + (extraSessions * GENERAL_TRAINING_PERCENTAGE));
            console.log('Total sublevel:', totalSublevel);
            
            return totalSublevel.toFixed(2);
        } catch (error) {
            console.error('Error parsing extra trainings:', error);
            console.error('Error details:', error.message);
            return Math.min(0.99, parseFloat(baseSublevel));
        }
    }
</script>

<div class="main-content wf100"> 
    <section class="wf100 p80">
        <div class="container">
            <div class="row">
                <h1>Player Prediction Tool</h1>
            </div>
            <div class="row player-input-container">
                <h2>Sokker Season: <span id="season-start">{{ season }}</span> weeks left: <span id="weeks-left">{{ training_sessions }}</span></h2>
            </div>
            <div class="row">
                <div class="col-lg-4 col-md-4 team-two player-input-container">
                    <h3>Step 1 - Set the age till which you want to train</h3>

                    <form id="player-update-form" method="POST">
                        <input type="hidden" name="step" value="1">
                        {% csrf_token %}
                        {% bootstrap_form form %}
                        <button type="submit" class="btn btn-primary mt-3">Calculate remaining sessions</button>
                    </form>
                </div>
                <div class="col-lg-1 col-md-1 separator-column">
                    <div class="arrow-right"></div>
                </div>
                <div class="col-lg-7 col-md-7 team-two player-prediction-container">
                    <h3>Player outcome at age <span id="age-feedback">{% if playerForm.age.value %}{{ playerForm.age.value }}{% else %}--{% endif %}</span></h3>
                    <input type="hidden" name="training_sessions_to_spare" value="{{ training_sessions_to_spare }}">
                    <div class="alert alert-info mb-3" role="alert">
                        Season: <strong><span id="season-feedback"></span></strong>
                        &nbsp;&nbsp;|&nbsp;&nbsp;
                        Week: <strong><span id="week-feedback">{{ training_sessions }}</span></strong>
                    </div>
                    <div class="alert alert-info mb-3" role="alert">
                        Remaining training sessions: <strong><span id="remaining-sessions">{{ training_sessions_to_spare }}</span></strong>
                    </div>
                    <form id="player-update-form-2" method="POST">
                        <input type="hidden" name="step" value="2">
                        {% csrf_token %}
                        {% bootstrap_form playerForm %}
                    </form>
                    <!-- Add training log container -->
                     <div class="player-training-history-container player-input-container">
                        <h3>Training Path</h3>
                        <div id="training-log" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4>Skill Training Factors</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Skill</th>
                                                <th>Factor</th>
        
                                            </tr>
                                        </thead>
                                        <tbody id="skill-factors-table">
                                            <!-- Table content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-info">
                                        <p><strong>Note:</strong> Training factors affect the number of sessions needed for skill improvement.</p>
                                        <p>For example, with factor 0.662 (Pace):</p>
                                        <ul>
                                            <li>Base sessions (3)  0.662 = 4.53 sessions</li>
                                            <li>Rounds up to 5 sessions needed</li>
                                            <li>Stores 53% progress towards next bonus</li>
                                        </ul>
                                        <p class="mb-0">When accumulated progress reaches 100%, one less session will be needed for the next improvement.</p>
                                        <p><strong>General Training:</strong> When training a skill, other skills receive a 15% general training effect based on their current level.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

